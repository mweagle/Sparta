<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]> <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]> <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Event Source - DynamoDB  &middot; Sparta</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1">


<meta name="description" content="" />

<meta name="keywords" content="sparta, event_source, ">


<meta property="og:title" content="Event Source - DynamoDB  &middot; Sparta ">
<meta property="og:site_name" content="Sparta"/>
<meta property="og:url" content="http://gosparta.io/docs/eventsources/dynamodb/" />
<meta property="og:locale" content="en-EN">


<meta property="og:type" content="article" />
<meta property="og:description" content=""/>
<meta property="og:article:published_time" content="2015-11-29T06:50:17Z" />
<meta property="og:article:modified_time" content="2015-11-29T06:50:17Z" />

  
    
<meta property="og:article:tag" content="sparta">
    
<meta property="og:article:tag" content="event_source">
    
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@" />
<meta name="twitter:creator" content="@" />
<meta name="twitter:title" content="Event Source - DynamoDB" />
<meta name="twitter:description" content="" />
<meta name="twitter:url" content="http://gosparta.io/docs/eventsources/dynamodb/" />
<meta name="twitter:domain" content="http://gosparta.io">
  

<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Event Source - DynamoDB",
    "author": {
      "@type": "Person",
      "name": "http://profiles.google.com/+?rel=author"
    },
    "datePublished": "2015-11-29",
    "description": "",
    "wordCount":  487 
  }
</script>



<link rel="canonical" href="http://gosparta.io/docs/eventsources/dynamodb/" />

<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://gosparta.io/touch-icon-144-precomposed.png">
<link href="http://gosparta.io/favicon.png" rel="icon">

<meta name="generator" content="Hugo 0.16" />

  <!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->



    <link rel="stylesheet" href="http://gosparta.io/css/theme/lumen.css">


<link rel="stylesheet" href="http://gosparta.io/css/font-awesome.min.css">
<link rel="stylesheet" href="http://gosparta.io/css/style.css">


  <link rel="stylesheet" href="http://gosparta.io/css/highlight/xcode.css">



  
  <script src="/mermaid_dist/mermaid.min.js"></script>
  <script>mermaid.initialize({startOnLoad:true});</script>
  <link rel="stylesheet" href="/mermaid_dist/mermaid.css"></link>
  <link rel="stylesheet" href="/css/mermaid-overrides.css"></link>


  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-70794971-2', 'auto');
    ga('send', 'pageview');
  </script>
</head>
<body class="map[youtube: name:lumen home:Sparta bitbucket: googleplus: twitter:mweagle flattr: googleAnalytics:UA-70794971-1 github:https://github.com/mweagle linkedin:https://www.linkedin.com/in/mweagle facebook:]">
    <header id="main-header">
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="http://gosparta.io"><img src="/images/SpartaLogoNoDomain.png" height=32 /></a>
      </div>
      <div id="navbar" class="collapse navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          
          <li>

            <a href="http://gosparta.io/docs"
            >

            
                <i class="fa fa-book"></i>
            

            Documentation
            </a>
          </li>
          
          <li>

            <a href="http://gosparta.io/docs/faq"
            >

            
                <i class="fa fa-question-circle"></i>
            

            FAQ
            </a>
          </li>
          
          <li>

            <a href="https://github.com/mweagle/Sparta"
            >

            
                <i class="fa fa-github"></i>
            

            GitHub
            </a>
          </li>
          
          <li>

            <a href="https://twitter.com/@mweagle"
            >

            
                <i class="fa fa-twitter"></i>
            

            mweagle
            </a>
          </li>
          
        </ul>
      </div>
      
    </div>
  </nav>
</header>


<div class="container content">
  <div class="row">
    <div class="col-md-2"><div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Contents</h3>
  </div>
  <div class="panel-body">
    
      <a href="/docs/">Overview</a>
      <ul>
      
      </ul>
    
      <a href="/docs/intro_example">Example</a>
      <ul>
      
      </ul>
    
      <a href="/docs/intro_example_details">Example - Details</a>
      <ul>
      
      </ul>
    
      <a href="/docs/eventsources">Event Sources</a>
      <ul>
      
        <li>
          <small><a href="/docs/eventsources/cloudformation">CloudFormation (TBD)</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/cloudwatchevents">CloudWatch Events</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/cloudwatchlogs">CloudWatch Logs</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/cognito">Cognito (TBD)</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/dynamodb">DynamoDB</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/kinesis">Kinesis</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/s3">S3</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/ses">SES</a></small>
        </li>
      
        <li>
          <small><a href="/docs/eventsources/sns/">SNS</a></small>
        </li>
      
      </ul>
    
      <a href="/docs/apigateway">API Gateway</a>
      <ul>
      
        <li>
          <small><a href="/docs/apigateway/example1">Echo</a></small>
        </li>
      
        <li>
          <small><a href="/docs/apigateway/example2">User Input</a></small>
        </li>
      
        <li>
          <small><a href="/docs/apigateway/example3">GeoIP Service</a></small>
        </li>
      
        <li>
          <small><a href="/docs/apigateway/cors">CORS</a></small>
        </li>
      
        <li>
          <small><a href="/docs/apigateway/slack">Slack Integration</a></small>
        </li>
      
      </ul>
    
      <a href="/docs/s3site">Static S3 Websites</a>
      <ul>
      
      </ul>
    
      <a href="/docs/dynamic_infrastructure">Dynamic Infrastructure</a>
      <ul>
      
      </ul>
    
      <a href="/docs/custom_resources">Custom Resources</a>
      <ul>
      
      </ul>
    
      <a href="/docs/discovery">Discovery</a>
      <ul>
      
      </ul>
    
      <a href="/docs/application">Application Customization</a>
      <ul>
      
        <li>
          <small><a href="/docs/application/commandline">Command Line Options</a></small>
        </li>
      
        <li>
          <small><a href="/docs/application/custom_flags">Adding Flags</a></small>
        </li>
      
        <li>
          <small><a href="/docs/application/custom_commands">Adding Commands</a></small>
        </li>
      
        <li>
          <small><a href="/docs/application/workflow_hooks">Workflow Hooks</a></small>
        </li>
      
        <li>
          <small><a href="/docs/application/environments">Managing Environments</a></small>
        </li>
      
      </ul>
    
      <a href="/docs/alternative_topologies">Alternative Topologies</a>
      <ul>
      
      </ul>
    
      <a href="/docs/docker">Docker &amp; ECS</a>
      <ul>
      
      </ul>
    
      <a href="/docs/local_testing">Local Testing</a>
      <ul>
      
      </ul>
    
      <a href="/docs/faq">FAQ</a>
      <ul>
      
      </ul>
    
      <a href="/docs/limitations">Limitations</a>
      <ul>
      
      </ul>
    
  </div>
</div>
</div>
    <div class="col-md-10">

      <header class="container hat">
  <h1>Event Source - DynamoDB
</h1>

</header>

      <hr />
      <div id="toc">
      <nav id="TableOfContents">
<ul>
<li><a href="#goal">Goal</a></li>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#{#HUGOSHORTCODE-2#">&lt;a href=&rdquo;</a></li>
<li><a href="#{#HUGOSHORTCODE-5#">&lt;a href=&rdquo;</a></li>
<li><a href="#event-source-mappings">Event Source Mappings</a></li>
<li><a href="#wrapping-up">Wrapping Up</a></li>
<li><a href="#other-resources">Other Resources</a></li>
<li><a href="#appendix">Appendix</a>
<ul>
<li><a href="#creating-a-dynamodb-stream">Creating a DynamoDB Stream</a>
<ul>
<li><a href="#select-table">Select Table</a></li>
<li><a href="#enable-stream">Enable Stream</a></li>
<li><a href="#copy-arn">Copy ARN</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
      </div>
      <hr />

      <div class="container content">
  

<p>In this section we&rsquo;ll walkthrough how to trigger your lambda function in response to DynamoDB stream events.  This overview is based on the <a href="https://github.com/mweagle/SpartaApplication">SpartaApplication</a> sample code if you&rsquo;d rather jump to the end result.</p>

<h1 id="goal">Goal</h1>

<p>Assume that we&rsquo;re given a DynamoDB stream.  See <a href="http://localhost:1313/docs/eventsources/dynamodb/#creatingDynamoDBStream:d680e8a854a7cbad6d490c445cba2eba">below</a> for details on how to create the stream.  We&rsquo;ve been asked to write a lambda function that logs when operations are performed to the table so that we can perform offline analysis.</p>

<h1 id="getting-started">Getting Started</h1>

<p>We&rsquo;ll start with an empty lambda function and build up the needed functionality.</p>

<pre><code class="go">func echoDynamoDBEvent(event *json.RawMessage,
                       context *sparta.LambdaContext,
                       w http.ResponseWriter,
                      logger *logrus.Logger)
{
  logger.WithFields(logrus.Fields{
    &#34;RequestID&#34;: context.AWSRequestID,
  }).Info(&#34;Request received&#34;)
}</code></pre>


<h1 id="{#HUGOSHORTCODE-2#">&lt;a href=&rdquo;</h1>

<p>#}&ldquo;&gt;Unmarshalling the DynamoDB Event</a></p>

<p>Since the <code>echoDynamoDBEvent</code> is expected to be triggered by DynamoDB events, we will unmarshal the <code>*json.RawMessage</code> data into an DynamoDB-specific event provided by Sparta via:</p>

<pre><code class="go">var lambdaEvent spartaDynamoDB.Event
err := json.Unmarshal([]byte(*event), &amp;lambdaEvent)
if err != nil {
  logger.Error(&#34;Failed to unmarshal event data: &#34;, err.Error())
  http.Error(w, err.Error(), http.StatusInternalServerError)
}</code></pre>


<p>DynamoDB events are delivered in batches, via lists of <a href="https://godoc.org/github.com/mweagle/Sparta/aws/dynamodb#EventRecord">EventRecords</a>, so we&rsquo;ll need to process each record.</p>

<pre><code class="go">for _, eachRecord := range lambdaEvent.Records {
  logger.WithFields(logrus.Fields{
    &#34;Keys&#34;:     eachRecord.DynamoDB.Keys,
    &#34;NewImage&#34;: eachRecord.DynamoDB.NewImage,
  }).Info(&#34;DynamoDb Event&#34;)
}</code></pre>


<p>That&rsquo;s enough to get the data into CloudWatch Logs.</p>

<h1 id="{#HUGOSHORTCODE-5#">&lt;a href=&rdquo;</h1>

<p>#}&ldquo;&gt;Sparta Integration</a></p>

<p>With the core of the <code>echoDynamoDBEvent</code> complete, the next step is to integrate the <strong>Go</strong> function with Sparta.  This is performed by the <a href="https://github.com/mweagle/SpartaApplication/blob/master/application.go#L114">appendDynamoDBLambda</a> function.  Since the <code>echoDynamoDBEvent</code> function doesn&rsquo;t access any additional services (Sparta enables CloudWatch Logs privileges by default), the integration is pretty straightforward:</p>

<pre><code class="go">lambdaFn = sparta.NewLambda(sparta.IAMRoleDefinition{}, echoDynamoDBEvent, nil)</code></pre>


<h1 id="event-source-mappings">Event Source Mappings</h1>

<p>If we were to deploy this Sparta application, the <code>echoDynamoDBEvent</code> function would have the ability to log DynamoDB stream events, but would not be invoked in response to events published by the stream.  To register for notifications, we need to configure the lambda&rsquo;s <a href="http://docs.aws.amazon.com/lambda/latest/dg/intro-core-components.html#intro-core-components-event-sources">EventSourceMappings</a>:</p>

<pre><code class="go">lambdaFn.EventSourceMappings = append(lambdaFn.EventSourceMappings, &amp;lambda.CreateEventSourceMappingInput{
    EventSourceArn:   aws.String(dynamoTestStream),
    StartingPosition: aws.String(&#34;TRIM_HORIZON&#34;),
    BatchSize:        aws.Int64(10),
    Enabled:          aws.Bool(true),
  })
lambdaFunctions = append(lambdaFunctions, lambdaFn)</code></pre>


<p>The <code>dynamoTestStream</code> param is the ARN of the Dynamo stream that that your lambda function will <a href="http://docs.aws.amazon.com/lambda/latest/dg/intro-invocation-modes.html">poll</a> (eg: <em>arn:aws:dynamodb:us-west-2:000000000000:table/myDynamoDBTable/stream/2015-12-05T16:28:11.869</em>).</p>

<p>The <code>EventSourceMappings</code> field is transformed into the appropriate <a href="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-lambda-eventsourcemapping.html">CloudFormation Resource</a> which enables automatic polling of the DynamoDB stream.</p>

<h1 id="wrapping-up">Wrapping Up</h1>

<p>With the <code>lambdaFn</code> fully defined, we can provide it to <code>sparta.Main()</code> and deploy our service.  The workflow below is shared by all DynamoDB stream based lambda functions:</p>

<ul>
<li>Define the lambda function (<code>echoDynamoDBEvent</code>).</li>
<li>If needed, create the required <a href="https://godoc.org/github.com/mweagle/Sparta*IAMRoleDefinition">IAMRoleDefinition</a> with appropriate privileges if the lambda function accesses other AWS services.</li>
<li>Provide the lambda function &amp; IAMRoleDefinition to <code>sparta.NewLambda()</code></li>
<li>Add the necessary <a href="https://godoc.org/github.com/aws/aws-sdk-go/service/lambda#CreateEventSourceMappingInput">EventSourceMappings</a> to the <code>LambdaAWSInfo</code> struct so that the lambda function is properly configured.</li>
</ul>

<h1 id="other-resources">Other Resources</h1>

<ul>
<li><a href="https://aws.amazon.com/blogs/aws/dynamodb-update-triggers-streams-lambda-cross-region-replication-app/">Using Triggers for Cross Region DynamoDB Replication</a></li>
</ul>

<hr />

<h1 id="appendix">Appendix</h1>

<h2 id="creating-a-dynamodb-stream">Creating a DynamoDB Stream</h2>

<p>To create a DynamoDB stream for a given table, follow the steps below:</p>

<h3 id="select-table">Select Table</h3>

<p><img src="/images/eventsources/dynamodb/DynamoDB_ManageStream.png" alt="Select Table" /></p>

<h3 id="enable-stream">Enable Stream</h3>

<p><img src="/images/eventsources/dynamodb/DynamoDB_Enable.png" alt="Enable Stream" /></p>

<h3 id="copy-arn">Copy ARN</h3>

<p><img src="/images/eventsources/dynamodb/DynamoDB_StreamARN.png" alt="Copy ARN" /></p>

<p>The <strong>Latest stream ARN</strong> value is the value that should be provided as the <code>EventSourceArn</code> in to the <a href="http://localhost:1313/docs/eventsources/dynamodb/#eventSourceMapping:d680e8a854a7cbad6d490c445cba2eba">Event Source Mappings</a>.</p>

</div>


      
    </div>
  </div>
</div>
      <footer class="footer">
    <div class="container hidden-print">
    <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
           <div class="pull-left">
  <a class="toplink" href="#">back to top</a>
</div>
<div class="pull-right">
  
</div>

        </div>
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 text-center">
          <small>
              
    
<div class="container footline">
  
  Sparta 0.9.3


</div>


    


          </small>
        </div>
     </div>
    </div>
</footer>

    <script src="http://gosparta.io/js/jquery.min-2.1.4.js"></script>
<script src="http://gosparta.io/js/bootstrap.min-3.3.5.js"></script>



<script type="text/javascript">
  (function() {
    
    
    if (window.location.hostname == "localhost")
      return;

    var dsq = document.createElement('script'); dsq.async = true; dsq.type = 'text/javascript';
    dsq.src = '//mweagle.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="http://gosparta.io/js/highlight.pack.js"></script>
<script src="http://gosparta.io/js/site.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



  </body>
</html>

